name: Maintenance Check & Create Issue (ohne externe Actions)

on:
  schedule:
    - cron: '0 9 * * 1' # Jeden Montag
  workflow_dispatch:

jobs:
  check-and-create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Repository klonen & Maintenance-Branch finden
        id: detect
        run: |
          git clone https://github.com/${{ github.repository }} repo
          cd repo

          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          git fetch --all

          BRANCHES=$(git branch -r | grep 'origin/maintenance-release-' | sed 's|origin/||')
          echo "Gefundene Branches:"
          echo "$BRANCHES"

          MAX_BRANCH=$(echo "$BRANCHES" | sed -E 's/.*release-([0-9]+)/\1 \0/' | sort -n | tail -1 | awk '{print $2}')
          echo "branch=$MAX_BRANCH" >> $GITHUB_OUTPUT

          git fetch origin main
          COMMITS=$(git log origin/main..origin/$MAX_BRANCH --oneline)

          if [ -z "$COMMITS" ]; then
            echo "✅ Keine ungemergten Änderungen"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Ungemergte Änderungen vorhanden"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: GitHub Issue erstellen (via REST API)
        if: ${{ steps.detect.outputs.changes == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ steps.detect.outputs.branch }}"
          TITLE="🛠 Ungemergte Änderungen in $BRANCH"
          BODY="Es wurden Änderungen im Branch \`$BRANCH\` gefunden, die noch nicht in \`main\` enthalten sind.\n\nBitte überprüfe, ob ein Merge oder ein Pull Request notwendig ist.\n\n_This issue was automatically created._"

          curl -X POST "https://api.github.com/repos/${REPO}/issues" \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "$(jq -n --arg title "$TITLE" --arg body "$BODY" '{title: $title, body: $body, labels: ["maintenance", "automated"]}')"
