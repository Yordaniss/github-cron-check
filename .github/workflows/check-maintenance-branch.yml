name: Maintenance Check & Create Issue (manuell oder automatisch)

permissions:
  contents: read
  issues: write

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Maintenance-Branch, der geprüft werden soll'
        required: false
        default: ''
      create_issue:
        description: 'Soll ein Issue erstellt werden, wenn Änderungen gefunden werden?'
        required: false
        default: 'true'
  schedule:
    - cron: '0 9 * * 1' # Jeden Montag

jobs:
  check-and-create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Repository klonen & Branch bestimmen
        id: detect
        run: |
          git clone https://github.com/${{ github.repository }} repo
          cd repo
          git fetch --all

          INPUT_BRANCH="${{ github.event.inputs.target_branch }}"
          if [ -z "$INPUT_BRANCH" ]; then
            echo "🔍 Kein Branch angegeben – suche höchsten maintenance-release-N"
            BRANCHES=$(git branch -r | grep 'origin/maintenance-release-' | sed 's|origin/||')
            MAX_BRANCH=$(echo "$BRANCHES" | sed -E 's/.*release-([0-9]+)/\1 \0/' | sort -n | tail -1 | awk '{print $2}')
          else
            MAX_BRANCH="$INPUT_BRANCH"
          fi

          echo "branch=$MAX_BRANCH" >> $GITHUB_OUTPUT

          git fetch origin main
          COMMITS=$(git log origin/main..origin/$MAX_BRANCH --oneline)

          if [ -z "$COMMITS" ]; then
            echo "✅ Keine ungemergten Änderungen"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Ungemergte Änderungen gefunden:"
            echo "$COMMITS"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Optionales GitHub Issue erstellen
        if: steps.detect.outputs.changes == 'true' && github.event.inputs.create_issue != 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ steps.detect.outputs.branch }}"
          TITLE="🛠 Ungemergte Änderungen in $BRANCH"
          BODY="Es wurden Änderungen im Branch \`$BRANCH\` gefunden, die noch nicht in \`main\` enthalten sind.\n\nBitte überprüfe, ob ein Merge oder ein Pull Request notwendig ist.\n\n_This issue was automatically created._"

          curl -X POST "https://api.github.com/repos/${REPO}/issues" \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "$(jq -n --arg title "$TITLE" --arg body "$BODY" '{title: $title, body: $body, labels: ["maintenance", "automated"]}')"
